name: Deploy SQL Scripts to PostgreSQL

on:
  push:
    branches: [main]

jobs:
  deploy-db:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set Up GCP CLI
      run: |
        curl -fsSL https://pkg.google.com/apt/doc | sudo apt-add-repository -
        sudo apt-get update
        sudo apt-get install google-cloud-sdk
        gcloud auth activate-service-account --key-file=${{ secrets.FEWS_SA_KEY }}

    - name: Execute SQL Scripts
      run: |
        gcloud sql connect tidy-crane-440110-e1:asia-south1:fews --user=postgres --password=rocky --host=34.47.174.243 --port=5432
        pg_restore --verbose --clean --single-transaction --dbname="postgres://postgres:rocky@localhost:5432/postgres" --format=plain --file="ssc_chittoor.sql"
